services:
  traefik:
    image: traefik:v3.1
    container_name: traefik
    ports:
      - '80:80'
      - '443:443'

    extra_hosts:
      - 'host.docker.internal:host-gateway'

    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock'
      - './letsencrypt:/letsencrypt'
      - './config/traefik.yaml:/etc/traefik/traefik.yaml:ro'
      - './config/dynamic:/etc/traefik/dynamic:ro'

    secrets:
      - 'cloudflare_token'

    environment:
      - 'AUTH_USER=${AUTH_USER}'
      - 'IP_WHITELIST=${IP_WHITELIST}'
      - 'DNS_VPS_IP=${DNS_VPS_IP}'
      - 'MAIN_VPS_IP=${MAIN_VPS_IP}'
      - 'PROXY_VPS_IP=${PROXY_VPS_IP}'
      - 'PRIMARY_MAIN_DOMAIN=${PRIMARY_MAIN_DOMAIN}'
      - 'SECONDARY_MAIN_DOMAIN=${SECONDARY_MAIN_DOMAIN}'
      - 'CF_DNS_API_TOKEN_FILE=/run/secrets/cloudflare_token'

    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.traefik.rule=Host(`${SERVICE_URL}`)'
      - 'traefik.http.routers.traefik.service=api@internal'
      - 'traefik.http.routers.traefik.middlewares=ip-whitelist@file,basic-auth@file'

secrets:
  cloudflare_token:
    file: './secrets/cloudflare_token'

networks:
  default:
    name: traefik
