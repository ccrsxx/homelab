services:
  traefik:
    # The official v3 Traefik docker image
    image: traefik:v3.1

    # Name
    container_name: traefik

    # Enables the web UI and tells Traefik to listen to docker
    command:
      # Debug log level
      - '--log.level=DEBUG'

      # Enable the Secured Web UI
      - '--api.dashboard=true'

      # Skip self signed SSL certificates
      - '--serversTransport.insecureSkipVerify=true'

      # Enable Docker as a provider and disable exposed by default
      - '--providers.docker=true'
      - '--providers.docker.exposedbydefault=false'

      # Enable File as a provider and watch the changes
      - '--providers.file.directory=/config'
      - '--providers.file.watch=true'

      # Setup entrypoints for HTTP and HTTPS and always redirect HTTP to HTTPS
      - '--entrypoints.web.address=:80'
      - '--entrypoints.websecure.address=:443'
      - '--entrypoints.websecure.asDefault=true'
      - '--entrypoints.web.http.redirections.entrypoint.to=websecure'
      - '--entrypoints.web.http.redirections.entrypoint.scheme=https'

      # Setup Domain and DNS challenge for Let's Encrypt
      - '--entrypoints.websecure.http.tls=true'
      - '--entrypoints.websecure.http.tls.certResolver=letsencrypt'
      - '--entrypoints.websecure.http.tls.domains[0].main=${MAIN_DOMAIN}'
      - '--entrypoints.websecure.http.tls.domains[0].sans=${WILDCARD_DOMAIN}'

      # Setup Let's Encrypt certificates resolver
      - '--certificatesresolvers.letsencrypt.acme.email=${CLOUDFLARE_EMAIL}'
      - '--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json'
      - '--certificatesresolvers.letsencrypt.acme.dnschallenge=true' 
      - '--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare'
      - '--certificatesresolvers.letsencrypt.acme.dnschallenge.delaybeforecheck=30'

    ports:
      # The HTTP port
      - '80:80'
      # The HTTPS port
      - '443:443'

    extra_hosts:
      - "host.docker.internal:host-gateway"

    volumes:
      # So that Traefik can listen to the Docker events
      - '/var/run/docker.sock:/var/run/docker.sock'
      - './letsencrypt:/letsencrypt'
      - './config:/config'

    secrets:
      - 'cloudflare_token'
      - 'cloudflare_email'

    environment:
      - 'AUTH_USER=${AUTH_USER}'
      - 'MAIN_DOMAIN=${MAIN_DOMAIN}'
      - 'IP_WHITELIST=${IP_WHITELIST}'
      - 'CF_DNS_API_TOKEN_FILE=/run/secrets/cloudflare_token'
      - 'CF_API_EMAIL_FILE=/run/secrets/cloudflare_email'

    labels:
      - 'traefik.enable=true'
      - 'traefik.http.routers.traefik.rule=Host(`${SERVICE_URL}`)'
      - 'traefik.http.routers.traefik.service=api@internal'
      - 'traefik.http.routers.traefik.middlewares=ip-whitelist@file,basic-auth@file'
      
secrets:
  cloudflare_token:
    file: './secrets/cloudflare_token'
  cloudflare_email:
    file: './secrets/cloudflare_email'

networks:
  default:
    name: traefik

